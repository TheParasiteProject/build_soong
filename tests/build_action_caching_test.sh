#!/bin/bash -u

set -o pipefail

# Test that the mk and ninja files generated by Soong don't change if some
# incremental modules are restored from cache.

OUTPUT_DIR="$(mktemp -d tmp.XXXXXX)"

echo ${OUTPUT_DIR}

function cleanup {
  rm -rf "${OUTPUT_DIR}"
}
trap cleanup EXIT

function run_soong_build {
  USE_RBE=false TARGET_PRODUCT=aosp_cf_x86_64_only_phone TARGET_RELEASE=trunk_staging TARGET_BUILD_VARIANT=eng build/soong/soong_ui.bash --make-mode "$@" nothing
}

function run_soong_clean {
  build/soong/soong_ui.bash --make-mode clean
}

function assert_files_equal {
  if [ $# -ne 2 ]; then
    echo "Usage: assert_files_equal file1 file2"
    exit 1
  fi

  if ! cmp -s "$1" "$2"; then
    echo "Files are different: $1 $2"
    exit 1
  fi
}

function test_build_action_restoring() {
  local test_dir="${OUTPUT_DIR}/test_build_action_restoring"
  mkdir -p ${test_dir}
  run_soong_clean
  cat > ${test_dir}/Android.bp <<'EOF'
python_binary_host {
  name: "my_little_binary_host",
  srcs: ["my_little_binary_host.py"],
}
EOF
  touch ${test_dir}/my_little_binary_host.py
  run_soong_build --incremental-build-actions
  local dir_before="${test_dir}/before"
  mkdir -p ${dir_before}
  cp -pr out/soong/*.mk out/soong/build.aosp_cf_x86_64*.ninja ${test_dir}/before
  # add a comment to the bp file, this should force a new analysis but no module
  # should be really impacted, so all the incremental modules should be skipped.
  cat >> ${test_dir}/Android.bp <<'EOF'
// new comments
EOF
  run_soong_build --incremental-build-actions
  local dir_after="${test_dir}/after"
  mkdir -p ${dir_after}
  cp -pr out/soong/*.mk out/soong/build.aosp_cf_x86_64*.ninja ${test_dir}/after

  compare_files_parity $dir_before $dir_after
  rm -rf "$test_dir"
  echo "test_build_action_restoring test passed"
}

function test_incremental_build_parity() {
  local test_dir="${OUTPUT_DIR}/test_incremental_build_parity"
  run_soong_clean
  run_soong_build
  local dir_before="${test_dir}/before"
  mkdir -p ${dir_before}
  cp -pr out/soong/*.mk out/soong/build.aosp_cf_x86_64*.ninja ${test_dir}/before

  # Now run clean build with incremental enabled
  run_soong_clean
  run_soong_build --incremental-build-actions
  local dir_after="${test_dir}/after"
  mkdir -p ${dir_after}
  cp -pr out/soong/*.mk out/soong/build.aosp_cf_x86_64*.ninja ${test_dir}/after

  compare_incremental_files $dir_before $dir_after
  rm -rf "$test_dir"
  echo "test_incremental_build_parity test passed"
}

function compare_incremental_files() {
  local dir_before=$1; shift
  local dir_after=$1; shift
  count=0
  for file_before in ${dir_before}/*.mk; do
    file_after="${dir_after}/$(basename "$file_before")"
    assert_files_equal $file_before $file_after
    ((count++))
  done
  echo "Compared $count mk files"

  count=0
  for file_before in ${dir_before}/*.ninja; do
    basename=$(basename "$file_before")
    file_after="${dir_after}/${basename}"
    # The after file should be a superset of the before one.
    if [[ "$basename" == "build.aosp_cf_x86_64_only_phone.ninja" ]]; then
      echo "Performing superset check for $basename..."
      extra_lines=$(comm -23 <(sort "$file_before") <(sort "$file_after"))
      if [[ -n "$extra_lines" ]]; then
        # If there are extra lines, print an error and the differing lines, then exit.
        echo "ERROR: $file_after is NOT a superset of $file_before."
        echo "The following lines were in the 'before' file but not the 'after' file:"
        echo "$extra_lines"
        exit 1
      fi
    else
      assert_files_equal $file_before $file_after
    fi
    ((count++))
  done
  echo "Compared $count ninja files"
}

function compare_files_parity() {
  local dir_before=$1; shift
  local dir_after=$1; shift
  count=0
  for file_before in ${dir_before}/*.*; do
    file_after="${dir_after}/$(basename "$file_before")"
    assert_files_equal $file_before $file_after
    ((count++))
  done
  echo "Compared $count ninja files"
}

test_incremental_build_parity
test_build_action_restoring
